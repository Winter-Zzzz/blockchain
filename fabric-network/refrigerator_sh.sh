#!/bin/bash

# 네트워크 설정이 완료되어 있어야 합니다!

# # 환경변수 설정
export PATH=${PWD}/../bin:$PATH
export FABRIC_CFG_PATH=$PWD/../config/
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051

# 재시작
# ./network.sh down
# ./network.sh up createChannel -c mychannel -ca

# 체인코드 배포
# ./network.sh deployCC -ccn matter-tunnel -ccp ../matter_tunnel/chaincode/ -ccl go

# alice가 디바이스의 pk 등록
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Register","Args":["04750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d946f1312034836474ccf7070b44d3e98f03dca538d148aff42fce155f58243de60d","045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","a781bba7b3d275100c6939afd440c158029e85c0a7f9ea967acc435e2e561fff5d307bfa138d014b3284a4a65bdcdf56eaae4b441ea81f64b72bb80f99ce9a0a"]}'

# 등록된 PK 조회
# peer chaincode query -C mychannel -n matter-tunnel -c '{"function":"GetRegisteredPKs","Args":["04750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d946f1312034836474ccf7070b44d3e98f03dca538d148aff42fce155f58243de60d"]}'

# setup 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","b7a3328a94e907a612bd2b710fae96ab69b17937aa8eedc776a14efee96cdf04514a4de1b9e326911573b3185d72465d65fb4a36a4f92b2151afd2447d843d0973657475700000000000000000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9468713436700000000e701468d96150537724b1361f511bfb3cceb65d0084a797d3fe86ed1384923639c651273878730d6669f46cd9fd216f672e986b6e4f4989cc66c2da9340ffc29"]}'

# setup 성공 확인
# peer chaincode query -C mychannel -n matter-tunnel -c '{"function":"GetRegisteredPKs","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8"]}'

# setTemperatureMode echo 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","de863447e374587595127d7f2b441c46106e3c799507bcb6c8a0c561ef4e4e98492b1138e528ec0055ea052b952f8d383d58fca0cbc819df180df7cbc0b39f4473657454656d70657261747572654d6f646503750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9468c15436700000000afd86e55455210f5870ff6583b3f309050982fab3ac86c0e34c550416e3b5758"]}'

# setTemperatureMode normal 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","b50de2de69de37ca2ae3a2ee359f4865072e087138622f4429ad6a9387204dcc369f31dd3a67cb7211926efdfa34592b9ed8ea4499b638c801dbe46f70d31dde73657454656d70657261747572654d6f646503750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9466215436700000000be20bac8cd01ed5a40ff70ca40327c8f68f648519cbf5b085e6e8d7ff854c66c"]}'

# setTemperatureMode rapid 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","73fdcb81a88bf9afb9f1213232451ac9bb89b01941b0815c62f7d930685e2d566c7550ecca325a956833a411373c29a3cef3907873832b729cf4114e5ef1d9f473657454656d70657261747572654d6f646503750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9469f154367000000008880f39c9b095898d9c139720e228d8428b7ae5c901c18f1f4ee1125ba6e5634"]}'

# changeColor red 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","939d08464d0cd1f64bf0adce5c3a4686d1870dba42289c05442e6326cc50a4671cfd5fd4b187ff3d0201a972e5e075095f8e6c32ddaf44d295d590e1bff9c9186368616e6765436f6c6f720000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d94687134367000000004bc020fadb0dccf251742f344f7f11f2774eeddece032575537174b98f3129b9"]}'

# changeColor black 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","1128b6138ab569567300b17a6bbc6e75335c599bcd459b3bd43057ba6680f7ae3b6cf8c5dd4ac053ed49050a5050f6e041379f08046704c313c26295b96d54af6368616e6765436f6c6f720000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d946bc1543670000000066a1f55388b1e44412c070af645d011d89c36eba4deae9ae7aab2ba3c9641e15"]}'

# changeColor magenta 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","8689be3513e71c7e8e482515b2956a94786d9bd66427332d26fc1ad5ada2dddc055f6bc37fd08b9ac57231ec559c54935db068577f0eb7d7f09cbf7cbf8b3b526368616e6765436f6c6f720000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d946f8154367000000008d6a764598bb4298631d339c7de6412b3dfa9ffd3d089cc284f1b549dd43f014"]}'

# changeColor cyan 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","7fbd2d3361299a1d49cf6b4ff79d59b11eae847179e5f9122b8db8868b6124f13f6530b5fcacd328d063a17f47b9bfa3711b1a231e6594a2641e741a6f7daf996368616e6765436f6c6f720000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9460816436700000000f6bb04899df32654315b5af09eca3cf447532ac74eb2ca72bc069b5dcaf8c3e2"]}'

# setAnimal dog 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","da218e716c54e72a0c0f0f7269bec0c68a16d4a0f310953b7f7db393494512e66599297a4598b65ce5116c28e435650db391c79cebeec0cfc08aaea88f1f2f8f736574416e696d616c00000000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9462d1643670000000078bf3cb64d18771f9e224db9961237fd7e76f72ba2f2e71414ffb7b7cd8f4855"]}'

# setAnimal cat 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","252676b6464e1cb46e227b759e1bac4d5564c0ceade9ae6f8a4da2607eeee42353470aa50ce050d126db498047a6d9da319c74e02cd25ce79a8f073d803e886f736574416e696d616c00000000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9464016436700000000f20929abd67c72f1b238df799d11c84a677c7e9d8657a2f2fdda1f4257477b45"]}'

# setAnimal none 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","83de4b9a5d92678c5b6ba679ef993c50c83b7eede402870afad7e39f841104cfc69c2247c3532213ba3102092f6b574a355644034a87b13689a40556b190cb97736574416e696d616c00000000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9464b1643670000000090909132a7d69bbc19add5b9e450a6f41ec3aa23f0598469bb8402945a985c15"]}'

# water true 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","03b3aac492f56ee35009cfe7001183522a5ccbd4bda86fe9223bca52362b9ef7efd09e143e2b377898bf082094c5671d7bb11cbbb478985e74a4766cc8a19b5c77617465720000000000000000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9468713436700000000ca3a90f35332e8bb80f2b9d5706f5c70568ac6ad76d0a6c6d88d2be5c7fab593"]}'

# water false 트랜젝션 전송 alice to device
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"Queuing","Args":["045b66e4d72c544f359588e24170442d4adf61d9d82ca93c58cca3193039ac03ef5a373255c003910ccbcc609c069d7ad077591d77263e5ad99f83d93fd4d5f5b8","fb18185ad83f382df8af5e05767fe0fc194838739b877dd8b6c40127bf289ad0b8305730b6b72cb9055f60130dc161d6ebd4fc6d75a62e64c535827a6553304c77617465720000000000000000000000000003750bfae2e57e7160cb5ead399ab37afdb4a1451a0b96b08764296dbe8490d9466a16436700000000b14390cfe7c03e7557ebf5d321f38a6acb586a3103a68df0ec505e3fad4c2921"]}'

# 모든 트랜젝션 출력
# peer chaincode query -C mychannel -n matter-tunnel -c '{"function":"GetAllTransactions","Args":[]}'

# 게이트웨이
# (cd ../matter_tunnel/application_gateway && go run .)

# 포맷
# peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n matter-tunnel --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"","Args":["",""]}'
